{
    "contents" : "---\ntitle: \"Preliminary Data Analysis of Severe Weather Events in the USA\"\nauthor: \"qpxu007\"\ndate: \"August 6, 2015\"\noutput: html_document\n---\n```{r echo=FALSE}\nlibrary(knitr)\n```\n\n## Synopsis\n\nIn the following excercise, we analyze the severe weather events collected by NOAA to answer two questions: 1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health? 2. Across the United States, which types of events have the greatest economic consequences?\n\n## Introduction\n\nThe severe weather event data collected by NOAA contains 902297 obs. of 37 variables. The \"EVTYPE\" column contains type of events. The health related columns \"FATALITIES\" and \"INJURIES\". The economic damage related columns are property damage (\"PROPDMG\" and \"PROPDMGEXP\") and crop damage(\"CROPDMG\" and \"CROPDMGEXP\").\n\n## Data Processing\n\nFirt, we read the data into a data frame (df):\n\n```{r cache=TRUE}\ndf<-read.csv(\"repdata-data-StormData.csv\")\nstr(df)\n```\n\nTo answer the questions raised above, we need to extract the following columns: \"EVTYPE\", \"FATALITIES\", \"INJURIES\", \"PROPDMG\", \"PROPDMGEXP\", \"CROPDMG\", and \"CROPDMGEXP\". For the damages, it should be noted that, the numbers in CROPDMG/PROPDMG columns are given in different units (kilo, mil, billion), which are set in the corresponding CROPDMGEXP/PROPDMGEXP columns. As a result, we need to do some cleaning up and conversion. So we subset part of the data into df2:\n\n```{r}\ns<-c(\"EVTYPE\",\"FATALITIES\",\"INJURIES\",\n     \"PROPDMG\",\"PROPDMGEXP\", \"CROPDMG\", \"CROPDMGEXP\")\ndf2 <- df[s]\n```\n\nFor the damages, it should be noted that, the numbers in CROPDMG/PROPDMG columns are given in different units (kilo, mil, billion), which are stored in the corresponding CROPDMGEXP/PROPDMGEXP columns respectively. Below we convert all damages into the same unit (Millions, we only deal with H, K, M, and B, the rest are assumed to be 0 since they are small in comparison):\n\n```{r}\ntrans <-function(unit) {\n  unit = toupper(unit)\n  nfactor = 0.0\n  if (unit == \"K\") {\n    nfactor <- 0.001\n  } else if (unit == \"H\") {\n    nfactor <- 0.0001\n  } else if (unit == \"M\") {\n    nfactor <- 1.0\n  } else if (unit == \"B\") {\n    nfactor <- 1000.0\n  }\n  nfactor\n}\n\ndf2$PROPDMGEXP<-sapply(df2$PROPDMGEXP, trans)\ndf2$PROPDMG<- df2$PROPDMG * df2$PROPDMGEXP\n\ndf2$CROPDMGEXP<-sapply(df2$CROPDMGEXP, trans)\ndf2$CROPDMG <- df2$CROPDMG * df2$CROPDMGEXP\n```\n\nWe now can add two new columns: \"health\" to combine injuries and fatalities, and \"damage\" to combine crop and property damages. We can also clean up df2 a bit by removing the unit columns (\"PROPDMGEXP\",\"CROPDMGEXP\") that are no longer needed.\n\n```{r}\ndf2$health <- df2$INJURIES+df2$FATALITIES\ndf2$damage <- df2$PROPDMG+df2$CROPDMG\ndf2$PROPDMGEXP<- df2$CROPDMGEXP  <- NULL\nstr(df2)\n```\n\n## Results\n\nTo answer questions above, we first need to aggregate the df2 with *sum* by EVTYPE, to generate a new data frame df3. \n\n```{r}\ndf3 <- aggregate(df2[c(\"health\",\"damage\", \"INJURIES\",\n                       \"FATALITIES\", \"CROPDMG\", \"PROPDMG\")],\n                       by=list(EVTYPE=df2$EVTYPE), FUN=sum)\nsummary(df3)\n```\n\nThe data frame df3 contains necessary information to answer the questions above. In the following, we create a function that process the data frame based on two columns (EVTYPE, and a consequence): first sort the data frame in decreasing order of the consequence; and then plot the top n EVTYPE (x) against consequence (y, in log scale and decreasing order).\n\n\n```{r}\nmyplot<-function(df, xcol=\"EVTYPE\", ycol=\"health\", n=5, \n                ylabel=\"Injuries and Fatalities\", \n                color=\"red\", offset=1.5) {\n   # sorted the df according the relevant ycol\n   df <- df[order(-df[,ycol]), ]\n   # select relevant columns and plot\n   y <- df[1:n,ycol]\n   x <- df[1:n,xcol]\n   seqx <- seq(x)\n\n   plot(seqx, log(y), type='b', xaxt='n', \n        ylab=paste(\"log(\",ylabel,\")\"), xlab=\"\", col=color)\n   axis(1,at=seqx, labels=F)\n   text(seqx, par(\"usr\")[3] - 0.2, labels = x, srt = 25, pos = 1, \n        xpd = TRUE, offset=offset, cex=1)\n}\n```\n\nNow, we can prepare a composite plots of EVTYPE vs various damages: \n\n```{r}\npar(mfrow=c(2,3))\nmyplot(df3,ycol='health', ylabel=\"Injuries and Fatalities\")\nmyplot(df3,ycol='FATALITIES', ylabel=\"Fatalities\")\nmyplot(df3,ycol='INJURIES', ylabel=\"Injuries\")\n\nmyplot(df3,ycol='damage', ylabel=\"Property and Crop Damages (Mil)\", color='blue')\nmyplot(df3,ycol='PROPDMG', ylabel=\"Property Damages (Mil)\", color='blue')\nmyplot(df3,ycol='CROPDMG', ylabel=\"Crop Damages (Mil)\", color='blue')\n```\n\nBased on the plot above, it can be observed that tornados cause most fatalities and injuries, while floods cause most economical damages (property and crop combined, and property alone). Drougt is the leading cause of crop damage.\n\n\n##Discussion\n\nBelow we will explore mapping of the damage data to the maps. We can prep data similar to above analysis, and retain the location and date columns.\n\n```{r}\ns<-c(\"EVTYPE\",\"FATALITIES\",\"INJURIES\",\n     \"PROPDMG\",\"PROPDMGEXP\", \"CROPDMG\", \"CROPDMGEXP\", \n     \"STATE\", \"BGN_DATE\", \"LATITUDE\", \"LONGITUDE\")\ndfx <- df[s]\n\n# fix date\ndfx$BGN_DATE<-as.Date(as.character(dfx$BGN_DATE), \n                      format=\"%m/%d/%Y %H:%M:%S\")\n# convert the lattitude and longitude data (assuming there are digital degrees)\ndfx$LATITUDE<-dfx$LATITUDE*0.01\ndfx$LONGITUDE<-dfx$LONGITUDE*0.01\n\ndfx$PROPDMGEXP<-sapply(dfx$PROPDMGEXP,trans)\ndfx$PROPDMG<- dfx$PROPDMG * dfx$PROPDMGEXP\n\ndfx$CROPDMGEXP<-sapply(dfx$CROPDMGEXP,trans)\ndfx$CROPDMG <- dfx$CROPDMG * dfx$CROPDMGEXP\n\ndfx$health <- dfx$INJURIES+dfx$FATALITIES\ndfx$damage <- dfx$PROPDMG+dfx$CROPDMG\ndfx$PROPDMGEXP<- dfx$CROPDMGEXP  <- NULL\n\nstates<-cbind(tolower(state.name),state.abb)\ncolnames(states)<-c('region','STATE')\ndfx<-merge(dfx, states, by=c(\"STATE\"))\nsummary(dfx)\n```\n\nWe can show the geospatial distribution of the human and economic costs of all the events for all time recorded.\n\n```{r}\ndf4<- aggregate(dfx[c(\"health\",\"damage\", \"INJURIES\",\n                      \"FATALITIES\", \"CROPDMG\", \"PROPDMG\")],\n                       by=list(region=dfx$region, STATE=dfx$STATE), FUN=sum)\n```\n\nWe can use ggplot2 for this. The following charts divide the severity of the damage into five levels, and color them accordingly.\n\n```{r}\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(gridExtra)\n\nstates_map <- map_data(\"state\")\n\n#prepare state labels\ncnames <-aggregate(cbind(long, lat) ~ region, data = states_map, \n                     FUN = function(x) mean(range(x)))\nstates_full_abbrev <-cbind(tolower(state.name),state.abb)\ncolnames(states_full_abbrev)<-c('region','STATE')\ncnames <-merge(cnames, states_full_abbrev, by=c('region'))\n#tweak label positions \ncnames[10, c(2:3)] <- c(-114.5, 43.5) # move label for idaho \ncnames[16, 3] <- 30.6 #LA\ncnames[20, c(2:3)] <- c(-84.5, 43) # MI\ncnames[8, c(2:3)] <- c(-81.5, 28) # FL\n\ntitle=\"Cumulative Injuries and Fatalities by State 1950-2011\"\ng1<-ggplot(df4, aes(map_id = region)) +\n    geom_map(aes(fill = cut_number(health,5)), map = states_map, color =\"white\") +\n    expand_limits(x = states_map$long, y = states_map$lat) +\n    ggtitle(title) + theme_bw()+\n    theme(plot.title = element_text(size=20, face=\"bold\", vjust=2),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\",\n          legend.title=element_blank(),\n          axis.ticks = element_blank(), \n          axis.title = element_blank(), \n          axis.text =  element_blank()) +\n  geom_text(data=cnames, aes(long, lat, label = STATE, map_id =NULL), size=3.5) +\n  coord_map()\ng1\n\ntitle=\"Cumulative Property and Crop Damage by State \\n1950-2011\"\ng2<-ggplot(df4, aes(map_id = region)) +\n    geom_map(aes(fill = cut_number(damage,5)), map = states_map, color =\"white\") +\n    expand_limits(x = states_map$long, y = states_map$lat) +\n    ggtitle(title) + theme_bw()+\n    theme(plot.title = element_text(size=20, face=\"bold\", vjust=2),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\",\n          legend.title=element_blank(),\n          axis.ticks = element_blank(), \n          axis.title = element_blank(), \n          axis.text =  element_blank()) +\n  geom_text(data=cnames, aes(long, lat, label = STATE, map_id =NULL), size=3.5) +\n  coord_map()\ng2\n```\n\n\n```{r echo=F}\n#grid.arrange(g1, g2, ncol = 2)\n# require(lubridate)\n# df4<- aggregate(dfx[c(\"health\",\"damage\", \"INJURIES\",\n#                       \"FATALITIES\", \"CROPDMG\", \"PROPDMG\")],\n#                        by=list(region=dfx$region, STATE=dfx$STATE, \n#                        Year=year(dfx$BGN_DATE)), FUN=sum)\n\n# library(choroplethr)\n# library(choroplethrMaps)\n# df4$value<-df4$health\n# state_choropleth(df4, legend=\"Injuries or Fatalities\",\n#                  title=\"Cumulative Injuries and Fatalities 1950-2011\")\n\n\n#require(rMaps)\n#ichoropleth(health~STATE, data=df4, animate = \"Year\", map='usa')\n```",
    "created" : 1439317602756.000,
    "dirty" : false,
    "encoding" : "ISO8859-1",
    "folds" : "",
    "hash" : "2289572891",
    "id" : "1B33DBE8",
    "lastKnownWriteTime" : 1439321680,
    "path" : "E:/R-classes/RepData/as2/RepData-as2.Rmd",
    "project_path" : "RepData-as2.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_markdown"
}